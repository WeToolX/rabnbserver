# å¼‚å¸¸é‡è¯•å¤„ç†çŸ¿æœºæ¡†æ¶

**ï¼ˆAbnormal Retry Processing Frameworkï¼‰**

***

## ä¸€ã€æ¡†æ¶ç›®æ ‡ä¸è®¾è®¡è¾¹ç•Œ

### 1ï¸âƒ£ è®¾è®¡ç›®æ ‡

è¯¥æ¡†æ¶ç”¨äºè§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

*   **ä¸šåŠ¡å¼‚å¸¸è‡ªåŠ¨æ¢å¤**
*   **å¼‚å¸¸ç»Ÿä¸€è½åº“ã€ç»Ÿä¸€è°ƒåº¦ã€ç»Ÿä¸€é‡è¯•**
*   **é¿å…å¼‚å¸¸å †ç§¯ã€é›ªå´©é‡è¯•**
*   **è‡ªåŠ¨ â†’ äººå·¥ çš„å¯æ§å‡çº§**
*   **ä¸šåŠ¡ä»£ç æœ€å°ä¾µå…¥ï¼ˆæ³¨è§£ + çº¦å®šæ–¹æ³•ï¼‰**

### 2ï¸âƒ£ æ¡†æ¶è¾¹ç•Œï¼ˆæ˜ç¡®ä¸åšçš„äº‹ï¼‰

*   âŒ ä¸è´Ÿè´£å…·ä½“ä¸šåŠ¡é€»è¾‘å®ç°
*   âŒ ä¸å…³å¿ƒå¼‚å¸¸æ¥æºï¼ˆç½‘ç»œ / ä¸‰æ–¹ / DB / é€»è¾‘ï¼‰
*   âŒ ä¸æ›¿ä»£äº‹åŠ¡ç³»ç»Ÿ
*   âŒ ä¸åšåˆ†å¸ƒå¼é”ï¼ˆç”±ä¸šåŠ¡ä¿è¯å¹‚ç­‰ï¼‰

**è°ƒç”¨è€…å¿…é¡»å®ç°!!!!**

1.  \*\*åœ¨ Service ç±»ä¸ŠåŠ æ³¨è§£  \*\*
2.  **å®ç° checkStatus        (åˆ¤æ–­ä¸šåŠ¡çŠ¶æ€çš„æ–¹æ³•)**
3.  **å®ç° ExceptionHandling   (ä¸šåŠ¡é‡è¯•çš„æ–¹æ³•)**
4.  **ä¸šåŠ¡å…¥å£è°ƒç”¨ checkUserErr  (å¿…é¡»è°ƒç”¨)**
5.  **æä¾› ProcessingSuccessful æ¥å£** (ç»™äººå·¥è°ƒç”¨å¤„ç†ç»“æœ)

***

## äºŒã€æ ¸å¿ƒè®¾è®¡æ¨¡å‹ï¼ˆå¼ºçº¦å®šï¼‰

### æ ¸å¿ƒåŸåˆ™

> **å¼‚å¸¸ = ä¸€æ¡ä¸šåŠ¡æ•°æ®çš„â€œæœªå®ŒæˆçŠ¶æ€â€**

æ¡†æ¶åªå…³å¿ƒä¸‰ä»¶äº‹ï¼š

1.  **è¿™æ¡æ•°æ®æ˜¯å¦å¼‚å¸¸**
2.  **æ˜¯å¦å¯ä»¥ç»§ç»­è‡ªåŠ¨å¤„ç†**
3.  **æ˜¯å¦éœ€è¦å‡çº§ä¸ºäººå·¥å¤„ç†**

***

## ä¸‰ã€å¼‚å¸¸çŠ¶æ€æ¨¡å‹ï¼ˆç»Ÿä¸€æšä¸¾ï¼Œå¼ºåˆ¶çº¦æŸï¼‰

### 1ï¸âƒ£ err\_statusï¼ˆå¼‚å¸¸ä¸»çŠ¶æ€ï¼‰

| å€¼    | å«ä¹‰      | è¯´æ˜     |
| :--- | :------ | :----- |
| 2000 | æ­£å¸¸      | æ— å¼‚å¸¸    |
| 4000 | å¼‚å¸¸å¾…è‡ªåŠ¨å¤„ç† | å¯é‡è¯•    |
| 4001 | å¼‚å¸¸éœ€äººå·¥å¤„ç† | è‡ªåŠ¨å¤±è´¥   |
| 2001 | è‡ªåŠ¨å¤„ç†æˆåŠŸ  | æ¡†æ¶å†™å…¥   |
| 2002 | äººå·¥å¤„ç†æˆåŠŸ  | äººå·¥æ¥å£å†™å…¥ |

ğŸ“Œ **ç»“è®ºï¼šerr\_status æ˜¯å¼‚å¸¸ç”Ÿå‘½å‘¨æœŸçš„å”¯ä¸€çŠ¶æ€æœº**

***

## å››ã€æ•°æ®åº“å¼ºåˆ¶å­—æ®µè§„èŒƒï¼ˆé—­ç¯ï¼‰

> **åªè¦ä½¿ç”¨æœ¬æ¡†æ¶ï¼Œä»¥ä¸‹å­—æ®µå¿…é¡»å­˜åœ¨**

### 1ï¸âƒ£ å¼‚å¸¸æ§åˆ¶å­—æ®µ

| å­—æ®µå                    | ç±»å‹       | è¯´æ˜         |
| :--------------------- | :------- | :--------- |
| err\_status            | int      | å¼‚å¸¸ä¸»çŠ¶æ€      |
| err\_start\_time       | datetime | é¦–æ¬¡å¼‚å¸¸æ—¶é—´     |
| err\_retry\_count      | int      | å·²é‡è¯•æ¬¡æ•°      |
| err\_next\_retry\_time | datetime | ä¸‹æ¬¡å…è®¸è‡ªåŠ¨é‡è¯•æ—¶é—´ |
| err\_min\_interval     | int      | æœ€å°é‡è¯•é—´éš”ï¼ˆç§’ï¼‰  |
| err\_timeout           | int      | æœ€å¤§å¤„ç†çª—å£ï¼ˆç§’ï¼‰  |

### 2ï¸âƒ£ äººå·¥å¤„ç†ç›¸å…³å­—æ®µ

| å­—æ®µå                            | ç±»å‹       | è¯´æ˜       |
| :----------------------------- | :------- | :------- |
| err\_submit\_manual\_status    | int      | äººå·¥å¤„ç†çŠ¶æ€   |
| err\_next\_remind\_staff\_time | datetime | ä¸‹æ¬¡æé†’äººå·¥æ—¶é—´ |

äººå·¥çŠ¶æ€æšä¸¾ï¼š

| å€¼    | å«ä¹‰     |
| :--- | :----- |
| 2000 | å·²æäº¤    |
| 4000 | æäº¤å¼‚å¸¸   |
| 4002 | äººå·¥å¤„ç†æˆåŠŸ |

***

## äº”ã€ä¸šåŠ¡çŠ¶æ€å­—æ®µï¼ˆå¼ºåˆ¶ä¸ä¸šåŠ¡ç»‘å®šï¼‰

### 1ï¸âƒ£ æ³¨è§£éœ€æä¾›çš„ä¸šåŠ¡çŠ¶æ€å‚æ•°

| å‚æ•°           | è¯´æ˜      |
| :----------- | :------ |
| statusField  | ä¸šåŠ¡çŠ¶æ€å­—æ®µå |
| successValue | æˆåŠŸå€¼     |
| failValue    | å¤±è´¥å€¼     |

ğŸ“Œ **æ¡†æ¶åˆ¤æ–­å¼‚å¸¸æ˜¯å¦ç»“æŸ = err\_status + ä¸šåŠ¡çŠ¶æ€åŒæ ¡éªŒ**

***

## å…­ã€æ ¸å¿ƒæ³¨è§£å®šä¹‰ï¼ˆè¡¥å…¨å­—æ®µï¼‰

### `@AbnormalRetryConfig`

```
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
public @interface AbnormalRetryConfig {

    /** æ•°æ®åº“è¡¨å */
    String table();

    /** å½“å‰æœåŠ¡ä¸­æ–‡æ ‡ç­¾ï¼ˆç”¨äºé‚®ä»¶/æ—¥å¿—ï¼‰ */
    String serviceName();

    /** ä¸»é”®å­—æ®µï¼ˆé»˜è®¤ idï¼‰ */
    String idField() default "id";

    /** ç”¨æˆ·æ ‡è¯†å­—æ®µ */
    String userField();

    /** ä¸šåŠ¡çŠ¶æ€å­—æ®µ */
    String statusField();

    /** ä¸šåŠ¡æˆåŠŸå€¼ */
    String successValue();

    /** ä¸šåŠ¡å¤±è´¥å€¼ */
    String failValue();

    /** æœ€å°é‡è¯•é—´éš”ï¼ˆç§’ï¼‰ */
    int minIntervalSeconds();

    /** å¼‚å¸¸å¤„ç†è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ */
    int timeoutSeconds();

    /** æœ€å¤§è‡ªåŠ¨é‡è¯•æ¬¡æ•° */
    int maxRetryCount();

    /** äººå·¥æé†’é—´éš”ï¼ˆç§’ï¼‰ */
    int manualRemindIntervalSeconds();
}

```

âœ… **æ³¨è§£ä¿¡æ¯ = æ¡†æ¶å…¨éƒ¨è¿è¡Œå‚æ•°æ¥æº**

***

## ä¸ƒã€Service å¿…é¡»å®ç°çš„æ–¹æ³•ï¼ˆå¼ºçº¦å®šï¼‰è°ƒç”¨è€…å¿…é¡»å®ç°

### 1ï¸âƒ£ æ£€æŸ¥çŠ¶æ€æ–¹æ³•

```
boolean checkStatus(Long dataId);

```

| ç»“æœ    | å«ä¹‰  |
| :---- | :-- |
| true  | å·²æˆåŠŸ |
| false | ä»å¼‚å¸¸ |

***

### 2ï¸âƒ£ å¼‚å¸¸é‡è¯•å¤„ç†æ–¹æ³•

```
boolean ExceptionHandling(Long dataId);

```

âš ï¸ **é‡è¦è§„åˆ™**

*   é‡è¯•æˆåŠŸï¼š

    *   å¿…é¡»å†™å…¥æ–°çš„ä¸šåŠ¡æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
    *   è¿”å› true
*   é‡è¯•å¤±è´¥ï¼š

    *   ä¸æŠ›å¼‚å¸¸
    *   è¿”å› false

***

## å…«ã€ä¸šåŠ¡å…¥å£å¼ºåˆ¶æ ¡éªŒï¼ˆé˜²é›ªå´©ï¼‰è°ƒç”¨è€…å¿…é¡»å®ç°

### `checkUserErr`

```java
void checkUserErr(String userValue);

```

#### æ ¡éªŒé€»è¾‘

```java
err_status = 4000
OR statusField = failValue

```

#### è¡Œä¸º

*   å‘½ä¸­ â†’ **ç›´æ¥æŠ›å¼‚å¸¸**
*   æœªå‘½ä¸­ â†’ æ­£å¸¸æ‰§è¡Œä¸šåŠ¡
*   **ç»“è®ºï¼šè¿™æ˜¯é˜²æ­¢â€œå¼‚å¸¸æœªç»“æŸç»§ç»­å †ç§¯â€çš„å…³é”®é—¸é—¨**

***

## ä¹ã€äººå·¥å¤„ç†æ¥å£ï¼ˆé—­ç¯ï¼‰

### `ProcessingSuccessful`

```json
void ProcessingSuccessful(Long dataId);

```

#### æ¡†æ¶æ‰§è¡Œå†…å®¹

*   err\_status â†’ 2002
*   statusField â†’ successValue

ğŸ“Œ **æ˜¯å¦å†™ä¸šåŠ¡æ•°æ®ç”±äººå·¥æ¥å£è‡ªè¡Œå†³å®š**

***

## åã€è°ƒåº¦æœåŠ¡é€»è¾‘ï¼ˆå®Œæ•´é—­ç¯ï¼‰

### 1ï¸âƒ£ åˆå§‹åŒ–é˜¶æ®µ

1.  æ‰«æ `@AbnormalRetryConfig`
2.  å»ºç«‹ï¼š

    *   è¡¨ â†’ Service æ˜ å°„
    *   è¡¨ â†’ æ³¨è§£å‚æ•°æ˜ å°„
3.  æ ¡éªŒå­—æ®µ
4.  **ç¼ºå¤±å­—æ®µ â†’ è‡ªåŠ¨ ALTER TABLE**

***

### 2ï¸âƒ£ è½®è¯¢ä»»åŠ¡ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰

> é—´éš”ä» `yml` è¯»å–

***

## åä¸€ã€å¼‚å¸¸è‡ªåŠ¨å¤„ç†æµç¨‹ï¼ˆé—­ç¯ï¼‰

### è‡ªåŠ¨å¤„ç†ç­›é€‰æ¡ä»¶ï¼ˆgetAllAbnormalDataï¼‰

```
err_status = 4000
AND (err_next_retry_time IS NULL OR err_next_retry_time <= now)
AND now - err_start_time < timeoutSeconds
AND err_retry_count < maxRetryCount
AND statusField = failValue

```

***

### è‡ªåŠ¨æ‰§è¡Œæµç¨‹ï¼ˆä¸¥æ ¼é¡ºåºï¼‰

```mermaid
flowchart TD
A[å–å¼‚å¸¸æ•°æ®] --> B[checkStatus]
B -->|æˆåŠŸ| C[RetrySuccessful]
B -->|å¤±è´¥| D[ExceptionHandling]
D --> E[checkStatus]
E -->|æˆåŠŸ| C
E -->|å¤±è´¥| F[RetryFailed]

```

***

## åäºŒã€RetryFailed é€»è¾‘æ‹†è§£ï¼ˆå…³é”®ï¼‰

### æ¡ä»¶ 1ï¼šä»å¯è‡ªåŠ¨å¤„ç†

*   æ›´æ–°ï¼š

    *   err\_retry\_count += 1
    *   err\_next\_retry\_time = now + åŠ¨æ€é€€é¿æ—¶é—´

**åŠ¨æ€é€€é¿å…¬å¼ï¼ˆå»ºè®®ï¼‰**

```
nextInterval = minIntervalSeconds * err_retry_count

```

***

### æ¡ä»¶ 2ï¼šè‡ªåŠ¨å¤±è´¥ â†’ å‡çº§äººå·¥

```
now - err_start_time > timeoutSeconds
OR err_retry_count >= maxRetryCount

```

è¡Œä¸ºï¼š

*   err\_status â†’ 4001
*   è§¦å‘ `sendErrToMail`

***

## åä¸‰ã€äººå·¥é€šçŸ¥é€»è¾‘ï¼ˆsendErrToMailï¼‰

### é‚®ä»¶å†…å®¹è§„èŒƒ

**æ ‡é¢˜**

```
ã€æœåŠ¡åã€‘å¼‚å¸¸è‡ªåŠ¨å¤„ç†è¶…é™ï¼Œè¯·äººå·¥å¤„ç†

```

**æ­£æ–‡**

```
å¼‚å¸¸ç”¨æˆ·ï¼šxxx
å¼‚å¸¸å¼€å§‹æ—¶é—´ï¼šxxx
å·²é‡è¯•æ¬¡æ•°ï¼šxxx
å¼‚å¸¸æŒç»­æ—¶é•¿ï¼šxxx ç§’

å®Œæ•´æ•°æ®ï¼š
{JSON}

```

***

## åå››ã€çŠ¶æ€æµè½¬å®Œæ•´æ€§æ ¡éªŒï¼ˆâœ… é—­ç¯ï¼‰

```
æ­£å¸¸(2000)
   â†“
å¼‚å¸¸å‘ç”Ÿ â†’ 4000
   â†“
è‡ªåŠ¨æˆåŠŸ â†’ 2001
   â†“
ç»“æŸ

æˆ–

è‡ªåŠ¨å¤±è´¥ â†’ 4001
   â†“
äººå·¥å¤„ç† â†’ 2002
   â†“
ç»“æŸ

```

âœ” æ— æ­»çŠ¶æ€\
âœ” æ— æ— æ³•é€€å‡ºè·¯å¾„\
âœ” æ¯æ¡å¼‚å¸¸æœ€ç»ˆå¿…è¾¾ç»ˆæ€

***

***

### **æ¡†æ¶å¼€å‘æ–‡æ¡£**

***

# å¼‚å¸¸é‡è¯•å¤„ç†çŸ¿æœºæ¡†æ¶

## å®ç°é€»è¾‘ï¼ˆFramework Implementationï¼‰

***

## ä¸€ã€æ¡†æ¶å®šä½

*   æœ¬æ¡†æ¶ä¸º **ç³»ç»Ÿçº§æœåŠ¡ç±»**
*   å¸¸é©»è¿è¡Œ
*   ä¸å‚ä¸å…·ä½“ä¸šåŠ¡
*   ä»…è´Ÿè´£ï¼š

    *   å¼‚å¸¸å‘ç°
    *   è‡ªåŠ¨é‡è¯•è°ƒåº¦
    *   çŠ¶æ€è¿ç§»
    *   äººå·¥å‡çº§é€šçŸ¥

***

## äºŒã€æ•´ä½“ç”Ÿå‘½å‘¨æœŸæ€»è§ˆ

```
ç³»ç»Ÿå¯åŠ¨
  â†“
æ‰«ææ³¨è§£ â†’ å»ºç«‹æ˜ å°„
  â†“
æ ¡éªŒå¹¶è¡¥é½æ•°æ®åº“å­—æ®µ
  â†“
å¯åŠ¨è½®è¯¢è°ƒåº¦æœåŠ¡
  â†“
è‡ªåŠ¨å¼‚å¸¸å¤„ç†
  â†“
è‡ªåŠ¨æˆåŠŸ æˆ– å‡çº§äººå·¥
  â†“
äººå·¥å¤„ç†æˆåŠŸ
  â†“
å¼‚å¸¸ç”Ÿå‘½å‘¨æœŸç»“æŸ

```

***

## ä¸‰ã€åˆå§‹åŒ–é˜¶æ®µï¼ˆç³»ç»Ÿå¯åŠ¨æ—¶ï¼‰

### 1ï¸âƒ£ æ‰«æå¼‚å¸¸å¤„ç†æ³¨è§£ç±»

#### è¡Œä¸º

*   æ‰«ææ‰€æœ‰æ ‡æ³¨ `@AbnormalRetryConfig` çš„ç±»
*   å¯¹æ¯ä¸€ä¸ªç±»ï¼š

    *   è§£ææ³¨è§£å‚æ•°
    *   ç»‘å®šï¼š

        *   **æ•°æ®åº“è¡¨å**
        *   **Service Bean**
        *   **çŠ¶æ€å­—æ®µè§„åˆ™**
        *   **æ—¶é—´ / æ¬¡æ•°æ§åˆ¶å‚æ•°**

#### ç»“æœ

æ„å»ºä»¥ä¸‹æ ¸å¿ƒå†…å­˜æ˜ å°„ï¼š

```
tableName â†’ AbnormalConfig
tableName â†’ ServiceInstance

```

ğŸ“Œ **è¯¥æ˜ å°„æ˜¯åç»­ä¸€åˆ‡é€»è¾‘çš„åŸºç¡€**

***

### 2ï¸âƒ£ æ ¡éªŒæ•°æ®åº“ç»“æ„ï¼ˆå¼ºåˆ¶ï¼‰

#### è¡Œä¸º

å¯¹æ¯ä¸€ä¸ªå·²æ˜ å°„çš„æ•°æ®åº“è¡¨ï¼š

*   æ£€æŸ¥æ˜¯å¦åŒ…å«æ¡†æ¶æ‰€éœ€å­—æ®µï¼š

    *   err\_status
    *   err\_start\_time
    *   err\_retry\_count
    *   err\_next\_retry\_time
    *   err\_min\_interval
    *   err\_timeout
    *   err\_submit\_manual\_status
    *   err\_next\_remind\_staff\_time

#### è§„åˆ™

*   å­—æ®µä¸å­˜åœ¨ â†’ **è‡ªåŠ¨ ALTER TABLE æ·»åŠ **
*   å­—æ®µå­˜åœ¨ â†’ è·³è¿‡
*   ä¸ä¿®æ”¹å·²æœ‰å­—æ®µå€¼

ğŸ“Œ **ä¿è¯æ¡†æ¶è¿è¡ŒæœŸä¸å› å­—æ®µç¼ºå¤±å¤±è´¥**

***

## å››ã€è½®è¯¢è°ƒåº¦æœåŠ¡

### 1ï¸âƒ£ è°ƒåº¦æ–¹å¼

*   å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚ `@Scheduled`ï¼‰
*   é»˜è®¤å‘¨æœŸï¼š**5 åˆ†é’Ÿ**
*   å‘¨æœŸé…ç½®æ¥æºï¼š

    *   `yaml` / `yml`
    *   å¦‚ï¼š`abnormal.retry.scan.interval`

***

### 2ï¸âƒ£ æ¯æ¬¡è½®è¯¢çš„æ€»ä½“æµç¨‹

```
for each æ˜ å°„çš„æ•°æ®åº“è¡¨:
    1. è·å–å¯è‡ªåŠ¨å¤„ç†å¼‚å¸¸æ•°æ®
    2. å¯¹æ¯æ¡æ•°æ®æ‰§è¡Œå¼‚å¸¸å¤„ç†æµç¨‹
    3. è·å–éœ€è¦äººå·¥é€šçŸ¥çš„æ•°æ®
    4. æ‰§è¡Œäººå·¥é€šçŸ¥

```

***

## äº”ã€å¼‚å¸¸è‡ªåŠ¨æ‰§è¡Œä¸»æµç¨‹

### å¼‚å¸¸è‡ªåŠ¨æ‰§è¡Œæµç¨‹å›¾ï¼ˆè§„èŒƒç‰ˆï¼‰

```mermaid
flowchart TD
A[è½®è¯¢å¼€å§‹] --> B[è·å–å¼‚å¸¸æ•°æ®]
B --> C[checkStatus]
C -->|æˆåŠŸ| D[RetrySuccessful]
C -->|å¤±è´¥| E[ExceptionHandling]
E --> F[å†æ¬¡ checkStatus]
F -->|æˆåŠŸ| D
F -->|å¤±è´¥| G[RetryFailed]

```

***

## å…­ã€æ ¸å¿ƒæ–¹æ³•è¯´æ˜ï¼ˆæ¡†æ¶å†…éƒ¨ï¼‰

***

### 1ï¸âƒ£ getAllAbnormalData

**è·å–å¯è‡ªåŠ¨å¤„ç†çš„å¼‚å¸¸æ•°æ®**

#### ç­›é€‰æ¡ä»¶ï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰

```
1. err_status = 4000
2. err_next_retry_time IS NULL OR err_next_retry_time <= å½“å‰æ—¶é—´
3. å½“å‰æ—¶é—´ - err_start_time < timeoutSecondsï¼ˆæ³¨è§£æä¾›ï¼‰
4. err_retry_count < maxRetryCountï¼ˆæ³¨è§£æä¾›ï¼‰
5. ä¸šåŠ¡çŠ¶æ€å­—æ®µ = ä¸šåŠ¡å¤±è´¥å€¼ï¼ˆæ³¨è§£æä¾›ï¼‰

```

#### ä½œç”¨

*   **å‡†å¤‡è‡ªåŠ¨é‡è¯•çš„æ•°æ®é›†åˆ**
*   ä¸åšä»»ä½•çŠ¶æ€ä¿®æ”¹

***

### 2ï¸âƒ£ checkStatusï¼ˆè°ƒç”¨ä¸šåŠ¡æ–¹ï¼‰

#### è¡Œä¸º

*   è°ƒç”¨å¯¹åº” Service çš„ `checkStatus(dataId)`

#### ç»“æœè§£é‡Š

| è¿”å›å€¼   | å«ä¹‰      |
| :---- | :------ |
| true  | å½“å‰æ•°æ®å·²æˆåŠŸ |
| false | å½“å‰æ•°æ®ä»å¼‚å¸¸ |

***

### 3ï¸âƒ£ RetrySuccessful

**è‡ªåŠ¨å¤„ç†æˆåŠŸï¼ˆç»ˆæ€ï¼‰**

#### è§¦å‘æ¡ä»¶

*   `checkStatus` è¿”å› `true`

#### æ‰§è¡Œé€»è¾‘

*   æ›´æ–°æ•°æ®åº“å­—æ®µï¼š

    *   `err_status = 2001`
    *   ä¸šåŠ¡çŠ¶æ€å­—æ®µ = æˆåŠŸå€¼ï¼ˆæ³¨è§£æä¾›ï¼‰

#### è¯´æ˜

*   ä¸å†å‚ä¸åç»­è½®è¯¢
*   å¼‚å¸¸ç”Ÿå‘½å‘¨æœŸç»“æŸ

***

### 4ï¸âƒ£ ExceptionHandlingï¼ˆè°ƒç”¨ä¸šåŠ¡æ–¹ï¼‰

#### è¡Œä¸º

*   è°ƒç”¨ä¸šåŠ¡å®ç°çš„å¼‚å¸¸é‡è¯•é€»è¾‘

#### æ³¨æ„äº‹é¡¹ï¼ˆæ¡†æ¶å‡è®¾ï¼‰

*   ä¸šåŠ¡æ–¹ï¼š

    *   ä¸æŠ›å¼‚å¸¸
    *   è¿”å› boolean
*   æ¡†æ¶ï¼š

    *   ä¸æ•è·ä¸šåŠ¡å¼‚å¸¸ç”¨äºé€»è¾‘åˆ¤æ–­
    *   åªçœ‹è¿”å›å€¼ + åç»­ `checkStatus`

***

### 5ï¸âƒ£ RetryFailed

**è‡ªåŠ¨å¤„ç†å¤±è´¥ï¼ˆä¸­é—´æ€æˆ–å‡çº§ï¼‰**

#### æ¡ä»¶ä¸€ï¼šä»å¯è‡ªåŠ¨å¤„ç†

```
err_status = 4000
AND å½“å‰æ—¶é—´ - err_start_time < timeoutSeconds
AND err_retry_count < maxRetryCount

```

#### æ‰§è¡Œé€»è¾‘ï¼ˆæ¡ä»¶ä¸€ï¼‰

1.  err\_retry\_count += 1
2.  è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´\
    ï¼ˆé‡è¯•æ¬¡æ•°è¶Šå¤šï¼Œé—´éš”è¶Šé•¿ï¼‰

**æ¨èå…¬å¼ï¼š**

```
nextInterval = minIntervalSeconds Ã— err_retry_count
err_next_retry_time = å½“å‰æ—¶é—´ + nextInterval

```

***

#### æ¡ä»¶äºŒï¼šè‡ªåŠ¨å¤„ç†å¤±è´¥ â†’ å‡çº§äººå·¥

```
err_status = 4000
AND (
    å½“å‰æ—¶é—´ - err_start_time > timeoutSeconds
    OR err_retry_count >= maxRetryCount
)
AND err_next_remind_staff_time < å½“å‰æ—¶é—´

```

#### æ‰§è¡Œé€»è¾‘ï¼ˆæ¡ä»¶äºŒï¼‰

1.  err\_status â†’ 4001
2.  è°ƒç”¨ `sendErrToMail`
3.  è®¾ç½®ä¸‹ä¸€æ¬¡äººå·¥æé†’æ—¶é—´ï¼ˆåŒæ ·ä½¿ç”¨é€€é¿é€»è¾‘ï¼‰

***

### 6ï¸âƒ£ getAllAbnormalDataNoticeManually

**è·å–éœ€è¦é€šçŸ¥äººå·¥çš„å¼‚å¸¸æ•°æ®**

#### ç­›é€‰æ¡ä»¶

```
1. err_status = 4000 æˆ– 4001
2. å½“å‰æ—¶é—´ - err_start_time > timeoutSeconds
3. err_retry_count >= maxRetryCount
4. err_next_remind_staff_time < å½“å‰æ—¶é—´
5. ä¸šåŠ¡çŠ¶æ€å­—æ®µ = å¤±è´¥å€¼

```

***

### 7ï¸âƒ£ sendErrToMail

**é€šçŸ¥äººå·¥å¤„ç†**

#### é‚®ä»¶å†…å®¹

*   æ ‡é¢˜

    ```
    ã€æœåŠ¡åã€‘å¼‚å¸¸è‡ªåŠ¨å¤„ç†è¶…é™ï¼Œè¯·äººå·¥å¤„ç†

    ```
*   å†…å®¹åŒ…å«ï¼š

    *   å¼‚å¸¸ç”¨æˆ·ï¼ˆuserFieldï¼‰
    *   å¼‚å¸¸å¼€å§‹æ—¶é—´
    *   å·²é‡è¯•æ¬¡æ•°
    *   å¼‚å¸¸æŒç»­æ—¶é•¿
    *   å®Œæ•´æ•°æ®å¿«ç…§ï¼ˆJSONï¼‰

#### é€šçŸ¥åå¤„ç†

*   æ›´æ–°ï¼š

    *   `err_next_remind_staff_time = å½“å‰æ—¶é—´ + åŠ¨æ€é€€é¿æ—¶é—´`

***

### 8ï¸âƒ£ ProcessingSuccessful

**äººå·¥å¤„ç†æˆåŠŸï¼ˆç»ˆæ€ï¼‰**

#### è§¦å‘æ¥æº

*   ç®¡ç†åå° / å®¢æœç³»ç»Ÿ / è¿ç»´æ¥å£

#### æ‰§è¡Œé€»è¾‘

*   æ›´æ–°ï¼š

    *   `err_status = 2002`
    *   ä¸šåŠ¡çŠ¶æ€å­—æ®µ = æˆåŠŸå€¼

ğŸ“Œ **å¼‚å¸¸ç”Ÿå‘½å‘¨æœŸæ­£å¼ç»“æŸ**

***

## ä¸ƒã€çŠ¶æ€é—­ç¯æ ¡éªŒï¼ˆå…³é”®ï¼‰

### çŠ¶æ€æµè½¬å›¾

```
2000 æ­£å¸¸
  â†“
4000 å¼‚å¸¸ï¼ˆè‡ªåŠ¨å¤„ç†ä¸­ï¼‰
  â†“
2001 è‡ªåŠ¨æˆåŠŸï¼ˆç»“æŸï¼‰

æˆ–

4001 éœ€äººå·¥å¤„ç†
  â†“
2002 äººå·¥æˆåŠŸï¼ˆç»“æŸï¼‰

```

### æ ¡éªŒç»“è®º

*   âœ… æ— æ­»å¾ªç¯
*   âœ… æ— æ— æ³•ç»“æŸçŠ¶æ€
*   âœ… æ¯æ¡å¼‚å¸¸å¿…è¾¾ç»ˆæ€
*   âœ… è‡ªåŠ¨ / äººå·¥è¾¹ç•Œæ¸…æ™°

***

## å…«ã€å®ç°å±‚é¢æ³¨æ„äº‹é¡¹ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

1.  **æ‰€æœ‰æ›´æ–°å¿…é¡»å¹‚ç­‰**
2.  **è½®è¯¢å†…å•æ¡æ•°æ®å¿…é¡» try-catch åŒ…è£¹**
3.  **ç¦æ­¢å¹¶å‘å¤„ç†åŒä¸€æ¡æ•°æ®**
4.  **ç¦æ­¢åœ¨æ¡†æ¶å±‚å†™ä¸šåŠ¡æ•°æ®**
5.  **checkStatus æ°¸è¿œæ˜¯æœ€ç»ˆè£åˆ¤**

***

## ä¹ æ¡†æ¶æ–¹æ³•è¡¨:

| æ–¹æ³•å                              | å«ä¹‰                        | æ‰§è¡Œé€»è¾‘                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | ä½œç”¨                   | å‚æ•°   | è¿”å›å€¼ |
| :------------------------------- | :------------------------ | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------- | :--- | :-- |
| getAllAbnormalData               | è·å–æ‰€æœ‰å·²ç»æ˜ å°„çš„æ•°æ®åº“å¼‚å¸¸æ•°æ®          | ç­›é€‰æ¡ä»¶:1.err\_status=4000 2.err\_*next\_retry\_time=ç©º/nullæˆ–å°äºå½“å‰æ—¶é—´ 3. å½“å‰æ—¶é—´-err\_*start\_time<æä¾›å¼‚å¸¸å¤„ç†è¶…æ—¶(ç§’/æ³¨è§£æä¾›)4. err\*\_retry\*\_count<æœ€å¤§é‡è¯•æ¬¡æ•°(æ³¨è§£æä¾›) 5.è¡¨ç¤ºçŠ¶æ€å­—æ®µå­—ç¬¦ä¸²(æ³¨è§£æä¾›)=è¡¨ç¤ºçŠ¶æ€å¤±è´¥å€¼                                                                                                                                                                                                                                                                                                                                 | å‡†å¤‡å¼‚å¸¸æ•°æ®               | æ—     | æ—    |
| getAllAbnormalDataNoticeManually | è·å–æ‰€æœ‰å·²ç»æ˜ å°„çš„æ•°æ®åº“å¼‚å¸¸è¶…æ—¶éœ€è¦é€šçŸ¥äººå·¥çš„æ•°æ® | ç­›é€‰æ¡ä»¶:1.err\_status=4000 2.å½“å‰æ—¶é—´-err\_*start\_*time>æä¾›å¼‚å¸¸å¤„ç†è¶…æ—¶(ç§’/æ³¨è§£æä¾›) 3.err\*\_retry\*\_count>æœ€å¤§é‡è¯•æ¬¡æ•°(æ³¨è§£æä¾›) 4. err\_*next*\_*remind\_*staff\_time<å½“å‰æ—¶é—´ 5.è¡¨ç¤ºçŠ¶æ€å­—æ®µå­—ç¬¦ä¸²(æ³¨è§£æä¾›)=è¡¨ç¤ºçŠ¶æ€å¤±è´¥å€¼                                                                                                                                                                                                                                                                                                                              | å‡†å¤‡é€šçŸ¥äººå·¥æ•°æ®             | æ—     | æ—    |
| checkUserErr                     | è·å–æŒ‡å®šç”¨æˆ·çš„å¼‚å¸¸è®°å½•               | è¿™ä¸ªæ–¹æ³•æ—¶æä¾›ç»™è°ƒç”¨è€…çš„:è·å–è°ƒç”¨è€…çš„ç±»çš„æ³¨è§£ è·å–åˆ°æ•°æ®åº“å å’Œæä¾›è¡¨ç¤ºçŠ¶æ€å­—æ®µå­—ç¬¦ä¸² è¡¨ç¤ºçŠ¶æ€æˆåŠŸå€¼ è¡¨ç¤ºçŠ¶æ€å¤±è´¥å€¼ æŸ¥è¯¢err\_status=4000æˆ–è€… è¡¨ç¤ºçŠ¶æ€å­—æ®µå­—ç¬¦ä¸²(æ³¨è§£æä¾›)=è¡¨ç¤ºçŠ¶æ€å¤±è´¥å€¼ å¦‚æœæœ‰åˆ™æŠ›å‡ºå¼‚å¸¸:å½“å‰æ“ä½œå­˜åœ¨å¼‚å¸¸è¯·è¿‡ä¸€ä¼šå†è¯•è¯•æˆ–è”ç³»å®¢æœ                                                                                                                                                                                                                                                                                                                                                                   | æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¼‚å¸¸æœªå¤„ç† å¦‚æœæœ‰åˆ™æŠ›å‡ºå¼‚å¸¸ | æ—     | æ—    |
| RetrySuccessful                  | è‡ªåŠ¨å¤„ç†é‡è¯•æˆåŠŸ                  | æ³¨è§£ç±»çš„checkStatusè°ƒç”¨ å¦‚æœæˆåŠŸåˆ™æ‰§è¡Œå½“å‰é€»è¾‘,è·å–æ³¨è§£çš„æ•°æ®åº“ è¡¨ç¤ºçŠ¶æ€å­—æ®µå­—ç¬¦ä¸²(æ³¨è§£æä¾›) è¡¨ç¤ºçŠ¶æ€æˆåŠŸå€¼(æ³¨è§£æä¾›) ä¿®æ”¹å­—æ®µ: 1.err\_status:2001 2.è¡¨ç¤ºçŠ¶æ€å­—æ®µå­—ç¬¦ä¸²(æ³¨è§£æä¾›) ä¿®æ”¹ä¸º è¡¨ç¤ºçŠ¶æ€æˆåŠŸå€¼(æ³¨è§£æä¾›)                                                                                                                                                                                                                                                                                                                                                                         | å¤„ç†æˆåŠŸ                 | æ•°æ®ID | æ—    |
| ProcessingSuccessful             | äººå·¥å¤„ç†åæ‰§è¡ŒæˆåŠŸ                 | è·å–æ³¨è§£çš„æ•°æ®åº“ è¡¨ç¤ºçŠ¶æ€å­—æ®µå­—ç¬¦ä¸²(æ³¨è§£æä¾›) è¡¨ç¤ºçŠ¶æ€æˆåŠŸå€¼(æ³¨è§£æä¾›) ä¿®æ”¹å­—æ®µ: 1.err\_status:2002 2.è¡¨ç¤ºçŠ¶æ€å­—æ®µå­—ç¬¦ä¸²(æ³¨è§£æä¾›) ä¿®æ”¹ä¸º è¡¨ç¤ºçŠ¶æ€æˆåŠŸå€¼(æ³¨è§£æä¾›)                                                                                                                                                                                                                                                                                                                                                                                                       | äººå·¥å¤„ç†æˆåŠŸ               | æ•°æ®ID | æ—    |
| RetryFailed                      | è‡ªåŠ¨å¤„ç†å¤±è´¥                    | æ¡ä»¶1:1.err\_status=4000 2.err\_*next\_retry\_time=ç©º/nullæˆ–å°äºå½“å‰æ—¶é—´ 3. å½“å‰æ—¶é—´-err\_*start\_time<æä¾›å¼‚å¸¸å¤„ç†è¶…æ—¶(ç§’/æ³¨è§£æä¾›)4. err\*\_retry\*\_count<æœ€å¤§é‡è¯•æ¬¡æ•°(æ³¨è§£æä¾›) 5.è¡¨ç¤ºçŠ¶æ€å­—æ®µå­—ç¬¦ä¸²(æ³¨è§£æä¾›)=è¡¨ç¤ºçŠ¶æ€å¤±è´¥å€¼ æ¡ä»¶1æ»¡è¶³åˆ™ 1.ä¿®æ”¹err\_*next\_retry\_time é€»è¾‘èµ·å§‹é—´éš”æ˜¯æšä¸¾æä¾›çš„ è®¾ç½®ä¸‹æ¬¡æ—¶é—´éœ€è¦å–å½“å‰æ—¶é—´-err\_*start\_timeä½œä¸ºä¸‹æ¬¡æ‰§è¡Œæ—¶é—´(ä¹Ÿå°±æ˜¯é‡‡ç”¨é‡è¯•æ¬¡æ•°è¶Šå¤š é—´éš”æ—¶é—´è¶Šé•¿) 2.err\*\_retry\*\_countè‡ªå¢1 æ¡ä»¶2:1.err\_status=4000 2.å½“å‰æ—¶é—´-err\_*start\_*time>æä¾›å¼‚å¸¸å¤„ç†è¶…æ—¶(ç§’/æ³¨è§£æä¾›) 3.err\*\_retry\*\_count>æœ€å¤§é‡è¯•æ¬¡æ•°(æ³¨è§£æä¾›) 4. err\_*next*\_*remind\_*staff\_time<å½“å‰æ—¶é—´ 5.è¡¨ç¤ºçŠ¶æ€å­—æ®µå­—ç¬¦ä¸²(æ³¨è§£æä¾›)=è¡¨ç¤ºçŠ¶æ€å¤±è´¥å€¼, æ¡ä»¶2æ»¡è¶³åˆ™é€šçŸ¥äººå·¥å¤„ç† | è‡ªåŠ¨ä¿®æ”¹å¼‚å¸¸çŠ¶æ€å¹¶ä¸”è‡ªåŠ¨å¤„ç†é€šçŸ¥äººå·¥   | æ•°æ®ID | æ—    |
| sendErrToMail                    | é€šçŸ¥äººå·¥å¤„ç†                    | ä»yumlé…ç½®æ‰¾åˆ°é‚®ç®±æ‰€éœ€å­—æ®µ,è‡ªåŠ¨æ„å»ºé‚®ä»¶æ ‡é¢˜å†…å®¹å‘é€,éœ€è¦å†…å®¹:æ ‡é¢˜:å½“å‰æœåŠ¡çš„ä¸­æ–‡æ ‡ç­¾(æ³¨è§£æä¾›) è‡ªåŠ¨å¤„ç†è¶…è¿‡ä¸Šé™,è¯·äººå·¥å¤„ç† å†…å®¹:å¼‚å¸¸ç”¨æˆ·:å–ç”¨æˆ·å­—æ®µå€¼(æ³¨è§£æä¾›çš„æ•°æ®åº“ä¸­ç”¨æˆ·çš„å­—æ®µ) (æ¢è¡Œ) å·²ç»é‡è¯•æ¬¡æ•°,å¼‚å¸¸æˆªæ­¢å½“å‰æ—¶é—´, é€šçŸ¥äººå·¥å¤„ç†æ¬¡æ•° (æ¢è¡Œ) å®Œæ•´æ•°æ® é€šçŸ¥ç»“æŸåè‡ªåŠ¨å°†err\_*next*\_*remind\_*staff\_time *è®¾ç½®ä¸‹æ¬¡æ—¶é—´éœ€è¦å–å½“å‰æ—¶é—´-err\_*start\_timeä½œä¸ºä¸‹æ¬¡æ‰§è¡Œæ—¶é—´(ä¹Ÿå°±æ˜¯é‡‡ç”¨é‡è¯•æ¬¡æ•°è¶Šå¤š é—´éš”æ—¶é—´è¶Šé•¿)                                                                                                                                                                                                                                                       | å‘é‚®ä»¶é€šçŸ¥äººå·¥              | æ•°æ®ID | æ—    |

